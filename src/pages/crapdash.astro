---
import Layout from '../layouts/Layout.astro';
import Dialog from '../components/ui/Dialog.astro';
import ToggleGroup from '../components/ui/ToggleGroup.astro';
import { Copy, Check, Container } from '@lucide/astro';

const repoUrl = 'https://github.com/austin-smith/crapdash';
const releasesUrl = 'https://github.com/austin-smith/crapdash/releases';
const dockerUrl = 'https://github.com/austin-smith/crapdash/pkgs/container/crapdash';
const iconUrl = '/images/crapdash/compy.png';
const screenshotLight = '/images/crapdash/screen-grabs/screen-grab-light.png';
const screenshotDark = '/images/crapdash/screen-grabs/screen-grab-dark.png';
---

<Layout
	title="crapshack (crapdash)"
	ogImage="/open-graph/crapdash.png"
	noIndex={true}
>
	<section class="mx-auto max-w-3xl space-y-8 mt-10">
		<header class="flex items-center gap-4">
			<img src={iconUrl} alt="crapdash icon" width="96" height="96" class="rounded-2xl drop-shadow-md" loading="lazy" />
			<div>
				<h1 class="text-3xl font-mono font-semibold bg-gradient-to-r from-[var(--color-brand)] to-white bg-clip-text text-transparent">crapdash</h1>
				<p class="text-white/90">Low-frills, customizable homepage to organize your links and services.</p>
			</div>
		</header>

		<div class="flex flex-wrap gap-3">
			<a href={repoUrl} target="_blank" rel="noopener noreferrer" class="inline-flex items-center rounded-md bg-[var(--color-brand)] px-4 py-2 font-medium hover:opacity-90 focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-[var(--color-brand)]/70">
				<img src="/images/brands/github-black.svg" alt="" aria-hidden="true" class="mr-2 h-4 w-4" />
				<span>github</span>
			</a>
			<a href={dockerUrl} target="_blank" rel="noopener noreferrer" class="inline-flex items-center rounded-md border border-white/20 px-4 py-2 font-medium text-[var(--color-text)] hover:text-[var(--color-brand)] focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-[var(--color-brand)]/70">
				<Container width={16} height={16} stroke-width={2} class="mr-2" />
				<span>docker image</span>
			</a>
		</div>

		<div class="screenshots grid grid-cols-1 sm:grid-cols-2 gap-4">
			<button
				type="button"
				class="screenshot-trigger group relative rounded-xl overflow-hidden border border-white/10 shadow-lg focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-[var(--color-brand)]"
				data-screenshot-trigger
				data-src={screenshotLight}
				data-alt="crapdash (light mode)"
			>
				<img src={screenshotLight} alt="crapdash (light mode)" class="w-full h-auto opacity-0 transition-all duration-300 group-hover:scale-[1.02]" data-screenshot loading="lazy" />
			</button>
			<button
				type="button"
				class="screenshot-trigger group relative rounded-xl overflow-hidden border border-white/10 shadow-lg focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-[var(--color-brand)]"
				data-screenshot-trigger
				data-src={screenshotDark}
				data-alt="crapdash (dark mode)"
			>
				<img src={screenshotDark} alt="crapdash (dark mode)" class="w-full h-auto opacity-0 transition-all duration-300 group-hover:scale-[1.02]" data-screenshot loading="lazy" />
			</button>
		</div>

		<Dialog id="screenshot-dialog" maxWidth="max-w-4xl" ariaLabel="screengrab preview dialog">
			<img id="screenshot-dialog-img" src="" alt="" class="w-full h-auto rounded-lg" />
			<div class="flex justify-center">
				<ToggleGroup
					name="screenshot-mode"
					options={[
						{ value: 'light', label: 'light' },
						{ value: 'dark', label: 'dark' },
					]}
					defaultValue="light"
					ariaLabel="Switch screengrab"
				/>
			</div>
		</Dialog>

		<section class="space-y-3">
			<h2 class="text-2xl font-mono font-semibold text-[var(--color-text)]"># Features</h2>
			<ul class="list-disc pl-6 space-y-1 text-white/95">
				<li><strong>Services</strong> - Save links with names, descriptions, and custom icons</li>
				<li><strong>Categories</strong> - Group services into categories with drag-and-drop organization</li>
				<li><strong>Admin panel</strong> - Manage services and categories through a simple UI</li>
				<li><strong>Search</strong> - Filter services quickly with keyboard shortcuts</li>
				<li><strong>Self-hosted</strong> - Run it on your own hardware via Docker or Node.js</li>
			</ul>
		</section>

	<section class="space-y-3">
		<h2 class="text-2xl font-mono font-semibold text-[var(--color-text)]"># Quick Start</h2>
		<p class="text-white/95">Deploy with Docker:</p>
		<div class="flex justify-start mb-3">
			<ToggleGroup
				name="docker-method"
				options={[
					{ value: 'docker', label: 'run' },
					{ value: 'compose', label: 'compose' },
				]}
				defaultValue="docker"
				ariaLabel="Switch deployment method"
			/>
		</div>
		<div class="relative group">
			<pre class="bg-black/40 rounded-lg p-4 pr-12 overflow-x-auto text-sm"><code id="docker-command" class="text-white/90">docker run -d \
  --name crapdash \
  -p 2727:2727 \
  --mount type=bind,source=/path/to/data,target=/app/data \
  --restart=unless-stopped \
  ghcr.io/austin-smith/crapdash:latest</code></pre>
			<button
				id="copy-btn"
				type="button"
				class="absolute top-3 right-3 p-1.5 rounded-md bg-white/10 text-white/60 hover:text-white hover:bg-white/20 transition-colors focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-[var(--color-brand)]/70"
				aria-label="Copy to clipboard"
			>
				<Copy id="copy-icon" width={16} height={16} stroke-width={2} />
				<Check id="check-icon" class="hidden" width={16} height={16} stroke-width={2} />
			</button>
		</div>
		<p class="text-white/95 pt-2">
			Or download a <a class="underline decoration-[var(--color-brand)] underline-offset-4 hover:text-[var(--color-brand)]" href={releasesUrl} target="_blank" rel="noopener noreferrer">prebuilt bundle</a> for standalone Node.js deployment.
		</p>
	</section>
	</section>
</Layout>

<script>
	import { copyTextToClipboard } from '../lib/clipboard';
	import { openDialog } from '../lib/ui/dialog';

	// Fade in screenshots on load
	const screenshots = document.querySelectorAll<HTMLImageElement>('[data-screenshot]');
	screenshots.forEach((img, i) => {
		const fadeIn = () => {
			setTimeout(() => {
				img.classList.remove('opacity-0');
				img.classList.add('opacity-100');
			}, i * 100);
		};
		if (img.complete) {
			fadeIn();
		} else {
			img.addEventListener('load', fadeIn, { once: true });
		}
	});

	// Screenshot dialog
	const screenshotTriggers = document.querySelectorAll<HTMLButtonElement>('[data-screenshot-trigger]');
	const dialogImg = document.getElementById('screenshot-dialog-img') as HTMLImageElement | null;
	const toggleGroup = document.querySelector<HTMLElement>('[data-toggle-group="screenshot-mode"]');

	// Screenshot sources
	const screenshotSources: Record<string, { src: string; alt: string }> = {
		light: { src: '/images/crapdash/screen-grabs/screen-grab-light.png', alt: 'crapdash (light mode)' },
		dark: { src: '/images/crapdash/screen-grabs/screen-grab-dark.png', alt: 'crapdash (dark mode)' },
	};

	function setScreenshot(mode: string) {
		if (!dialogImg) return;
		const source = screenshotSources[mode];
		if (source) {
			dialogImg.src = source.src;
			dialogImg.alt = source.alt;
		}
	}

	function setToggleValue(name: string, value: string) {
		const radio = document.querySelector<HTMLInputElement>(
			`[data-toggle-group="${name}"] input[value="${value}"]`
		);
		if (radio) {
			radio.checked = true;
		}
	}

	screenshotTriggers.forEach((trigger) => {
		trigger.addEventListener('click', () => {
			const src = trigger.dataset.src;
			const alt = trigger.dataset.alt;
			if (dialogImg && src) {
				dialogImg.src = src;
				dialogImg.alt = alt ?? '';

				// Set toggle to match clicked screenshot
				const mode = src.includes('light') ? 'light' : 'dark';
				setToggleValue('screenshot-mode', mode);

				openDialog('screenshot-dialog');
			}
		});
	});

	// Listen for toggle changes
	toggleGroup?.addEventListener('toggle-change', ((e: CustomEvent<{ value: string }>) => {
		setScreenshot(e.detail.value);
	}) as EventListener);

	// Docker method toggle
	const dockerMethodToggle = document.querySelector<HTMLElement>('[data-toggle-group="docker-method"]');
	const codeEl = document.getElementById('docker-command');

	const deploymentMethods: Record<string, string> = {
		docker: `docker run -d \\
  --name crapdash \\
  -p 2727:2727 \\
  --mount type=bind,source=/path/to/data,target=/app/data \\
  --restart=unless-stopped \\
  ghcr.io/austin-smith/crapdash:latest`,
		compose: `services:
  crapdash:
    image: ghcr.io/austin-smith/crapdash:latest
    container_name: crapdash
    restart: unless-stopped
    ports:
      - "2727:2727"
    volumes:
      - ./crapdash:/app/data`,
	};

	function setDeploymentMethod(method: string) {
		if (!codeEl) return;
		const snippet = deploymentMethods[method];
		if (snippet) {
			codeEl.textContent = snippet;
		}
	}

	dockerMethodToggle?.addEventListener('toggle-change', ((e: CustomEvent<{ value: string }>) => {
		setDeploymentMethod(e.detail.value);
	}) as EventListener);

	// Copy button
	const copyBtn = document.getElementById('copy-btn');
	const copyIcon = document.getElementById('copy-icon');
	const checkIcon = document.getElementById('check-icon');

	copyBtn?.addEventListener('click', async () => {
		const text = codeEl?.textContent ?? '';
		const success = await copyTextToClipboard(text);
		
		if (success && copyIcon && checkIcon) {
			copyIcon.classList.add('hidden');
			checkIcon.classList.remove('hidden');
			
			setTimeout(() => {
				copyIcon.classList.remove('hidden');
				checkIcon.classList.add('hidden');
			}, 2000);
		}
	});
</script>

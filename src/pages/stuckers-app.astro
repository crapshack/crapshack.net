---
import Layout from '../layouts/Layout.astro';
import Dialog from '../components/ui/Dialog.astro';
import ToggleGroup from '../components/ui/ToggleGroup.astro';
import { Copy, CopyCheck } from '@lucide/astro';

const repoUrl = 'https://github.com/austin-smith/Stuckers';
const appStoreUrl = 'https://apps.apple.com/us/app/stuckers/id1173389437';
const iconUrl = '/images/stuckers/stuckers-icon.png';

const screenshots = [
	{ id: 'all', src: '/images/stuckers/screen-grabs/screengrab-all.png', alt: 'Stuckers sticker pack overview' },
	{ id: 'oat-milk-man', src: '/images/stuckers/screen-grabs/screengrab-oat-milk-man.png', alt: 'Stuckers oat milk man sticker' },
	{ id: 'wink', src: '/images/stuckers/screen-grabs/screengrab-wink.png', alt: 'Stuckers wink sticker' },
];
---

<Layout
	title="crapshack (stuckers)"
	ogImage="/open-graph/stuckers.gif"
	noIndex={true}
>
	<section class="mx-auto max-w-3xl space-y-8 mt-10">
		<header class="flex items-center gap-4">
			<img src={iconUrl} alt="Stuckers icon" width="96" height="96" class="rounded-2xl drop-shadow-md" loading="lazy" />
			<div>
				<h1 class="text-3xl font-mono font-semibold bg-gradient-to-r from-[var(--color-brand)] to-white bg-clip-text text-transparent">Stuckers</h1>
				<p class="text-white/90">Hand-drawn animated sticker pack for iMessage. (i.e., stickers for phone.)</p>
			</div>
		</header>

		<div class="flex flex-wrap gap-3">
			<a href={repoUrl} target="_blank" rel="noopener noreferrer" class="inline-flex items-center rounded-md bg-[var(--color-brand)] px-4 py-2 font-medium hover:opacity-90 focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-[var(--color-brand)]/70">
				<img src="/images/brands/github.svg" alt="" aria-hidden="true" class="mr-2 h-4 w-4" />
				<span>github</span>
			</a>
			<a
				href={appStoreUrl}
				target="_blank"
				rel="noopener noreferrer"
				aria-label="Download Stuckers on the App Store"
				class="inline-flex items-center rounded-md border border-white/20 px-4 py-2 font-medium text-[var(--color-text)] hover:text-[var(--color-brand)] focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-[var(--color-brand)]/70"
			>
				<span aria-hidden="true" class="mr-2 h-4 w-4 shrink-0 icon-apple"></span>
				<span>app store</span>
			</a>
		</div>

		<div class="screenshots flex flex-wrap gap-4">
			{screenshots.map((screenshot) => (
				<button
					type="button"
					class="screenshot-trigger group relative rounded-xl overflow-hidden border border-white/10 shadow-lg focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-[var(--color-brand)] max-w-[120px] sm:max-w-[140px]"
					data-screenshot-trigger
					data-src={screenshot.src}
					data-alt={screenshot.alt}
					data-id={screenshot.id}
				>
					<img src={screenshot.src} alt={screenshot.alt} class="w-full h-auto opacity-0 transition-all duration-300 group-hover:scale-[1.02]" data-screenshot loading="lazy" />
				</button>
			))}
		</div>

		<Dialog id="screenshot-dialog" maxWidth="max-w-sm" ariaLabel="Stuckers screenshot preview">
			<img id="screenshot-dialog-img" src="" alt="" class="w-full h-auto max-h-[70vh] object-contain rounded-lg" />
			<div class="flex justify-center">
				<ToggleGroup
					name="screenshot-view"
					options={[
						{ value: 'all', label: 'all' },
						{ value: 'oat-milk-man', label: 'milk' },
						{ value: 'wink', label: 'wink' },
					]}
					defaultValue="all"
					ariaLabel="Switch screenshot view"
				/>
			</div>
		</Dialog>

		<section class="space-y-3">
			<h2 class="text-2xl font-mono font-semibold text-[var(--color-text)]"># Roster</h2>
			<div class="grid grid-cols-5 gap-3">
				{[
					{ name: 'popcorn', src: '/images/stuckers/stickers/popcorn.gif', alt: 'popcorn' },
					{ name: 'spiral', src: '/images/stuckers/stickers/spiral.gif', alt: 'spiral' },
					{ name: 'milk', src: '/images/stuckers/stickers/milk.gif', alt: 'milk' },
					{ name: 'hair', src: '/images/stuckers/stickers/hair.gif', alt: 'hair' },
					{ name: 'brows', src: '/images/stuckers/stickers/brows.gif', alt: 'brows' },
					{ name: 'blinky', src: '/images/stuckers/stickers/blinky.gif', alt: 'blinky' },
					{ name: 'test-tube', src: '/images/stuckers/stickers/test-tube.gif', alt: 'test tube' },
					{ name: 'wine', src: '/images/stuckers/stickers/wine.gif', alt: 'wine' },
					{ name: 'wink', src: '/images/stuckers/stickers/wink.gif', alt: 'wink' },
					{ name: 'robot', src: '/images/stuckers/stickers/robot.gif', alt: 'robot' },
				].map(({ name, src, alt }) => (
					<figure class="group relative rounded-xl bg-white/70 p-2 overflow-hidden shadow-md aspect-square grid place-items-center" data-sticker-tile data-copy-url={src} data-name={name}>
						<img
							src={src}
							alt={alt}
							width="480"
							height="480"
							decoding="async"
							data-sticker-img
							class="block h-auto w-auto max-h-full max-w-full object-contain object-center origin-center transition-opacity duration-300 opacity-0 group-hover:opacity-60 group-focus-within:opacity-60 group-data-[mode=feedback]:opacity-40 drop-shadow-lg transform-gpu transition-transform group-hover:scale-[1.03]"
							loading="lazy"
						/>
						<button
							type="button"
							class="absolute inset-0 z-[1] flex h-full w-full cursor-pointer rounded-xl text-white opacity-0 transition-opacity focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-[var(--color-brand)] group-hover:opacity-100 group-focus-within:opacity-100 group-data-[active=true]:opacity-100"
							data-copy-url={src}
							data-tile-button
							aria-label={`Copy link to ${name} GIF`}
						>
							<span class="absolute left-2 top-2 inline-flex items-center rounded bg-black/60 group-data-[mode=feedback]:bg-black/70 px-2 py-0.5 text-xs font-mono text-white shadow-sm select-none whitespace-nowrap leading-none transform-gpu">
								<span class="inline-flex items-center justify-center relative w-4 h-4 shrink-0 align-middle leading-none will-change-[opacity] transform-gpu">
									<Copy width={14} height={14} stroke-width={2.25} stroke="#fff" aria-hidden="true" class="absolute inset-0 opacity-100 transition-opacity group-data-[mode=feedback]:opacity-0" />
									<CopyCheck width={14} height={14} stroke-width={2.25} stroke="#fff" aria-hidden="true" class="absolute inset-0 opacity-0 transition-opacity group-data-[mode=feedback]:opacity-100" />
								</span>
								<span data-label aria-live="polite" class="leading-none ml-1.5">{name}</span>
							</span>
						</button>
					</figure>
				))}
			</div>
		</section>
	</section>
</Layout>

<script>
	import { openDialog } from '../lib/ui/dialog';
	import { copyTextToClipboard, toAbsoluteUrl } from '../lib/clipboard';

	// Fade in screenshots on load
	const screenshots = document.querySelectorAll<HTMLImageElement>('[data-screenshot]');
	screenshots.forEach((img, i) => {
		const fadeIn = () => {
			setTimeout(() => {
				img.classList.remove('opacity-0');
				img.classList.add('opacity-100');
			}, i * 100);
		};
		if (img.complete) {
			fadeIn();
		} else {
			img.addEventListener('load', fadeIn, { once: true });
		}
	});

	// Screenshot dialog
	const screenshotTriggers = document.querySelectorAll<HTMLButtonElement>('[data-screenshot-trigger]');
	const dialogImg = document.getElementById('screenshot-dialog-img') as HTMLImageElement | null;
	const toggleGroup = document.querySelector<HTMLElement>('[data-toggle-group="screenshot-view"]');

	// Screenshot sources
	const screenshotSources: Record<string, { src: string; alt: string }> = {
		'all': { src: '/images/stuckers/screen-grabs/screengrab-all.png', alt: 'stucker overview' },
		'oat-milk-man': { src: '/images/stuckers/screen-grabs/screengrab-oat-milk-man.png', alt: 'oat milk man stucker' },
		'wink': { src: '/images/stuckers/screen-grabs/screengrab-wink.png', alt: 'wink stucker' },
	};

	function setScreenshot(mode: string) {
		if (!dialogImg) return;
		const source = screenshotSources[mode];
		if (source) {
			dialogImg.src = source.src;
			dialogImg.alt = source.alt;
		}
	}

	function setToggleValue(name: string, value: string) {
		const radio = document.querySelector<HTMLInputElement>(
			`[data-toggle-group="${name}"] input[value="${value}"]`
		);
		if (radio) {
			radio.checked = true;
		}
	}

	screenshotTriggers.forEach((trigger) => {
		trigger.addEventListener('click', () => {
			const src = trigger.dataset.src;
			const alt = trigger.dataset.alt;
			const id = trigger.dataset.id;
			if (dialogImg && src) {
				dialogImg.src = src;
				dialogImg.alt = alt ?? '';

				// Set toggle to match clicked screenshot
				if (id) {
					setToggleValue('screenshot-view', id);
				}

				openDialog('screenshot-dialog');
			}
		});
	});

	// Listen for toggle changes
	toggleGroup?.addEventListener('toggle-change', ((e: CustomEvent<{ value: string }>) => {
		setScreenshot(e.detail.value);
	}) as EventListener);

	// Fade in sticker images as they load with staggered timing
	const stickerImages = Array.from(document.querySelectorAll('[data-sticker-img]'));
	for (let i = 0; i < stickerImages.length; i++) {
		const img = stickerImages[i];
		if (!(img instanceof HTMLImageElement)) continue;
		
		const staggerDelay = i * 40; // 40ms delay between each image
		
		const fadeIn = () => {
			setTimeout(() => {
				img.classList.remove('opacity-0');
				img.classList.add('opacity-100');
			}, staggerDelay);
		};
		
		if (img.complete) {
			// Image already loaded (cached)
			fadeIn();
		} else {
			// Fade in when image loads
			img.addEventListener('load', fadeIn, { once: true });
		}
	}

	// Sticker tile copy functionality
	const tiles = Array.from(document.querySelectorAll('[data-sticker-tile]'));
	for (const tile of tiles) {
		const button = tile.querySelector('[data-tile-button]');
		if (!(button instanceof HTMLButtonElement)) continue;
		const label = button.querySelector('[data-label]');
		if (!(label instanceof HTMLElement)) continue;
		const stickerName = tile.getAttribute('data-name') || '';
		let feedbackTimer: number | null = null;
		const defaultLabel = stickerName;
		const feedbackLabel = 'Copied!';

		const setMode = (mode: 'feedback' | 'default') => {
			if (mode === 'feedback') {
				tile.setAttribute('data-active', 'true');
				tile.setAttribute('data-mode', 'feedback');
				label.textContent = feedbackLabel;
			} else {
				tile.removeAttribute('data-mode');
				tile.removeAttribute('data-active');
				label.textContent = defaultLabel;
			}
		};

		button.addEventListener('click', async (ev) => {
			ev.preventDefault();
			const url = toAbsoluteUrl(button.getAttribute('data-copy-url') || '');
			await copyTextToClipboard(url);
			setMode('feedback');
			if (feedbackTimer) window.clearTimeout(feedbackTimer);
			feedbackTimer = window.setTimeout(() => setMode('default'), 1200);
		});

		// Touch: keep overlay visible on first tap via feedback path
		tile.addEventListener('touchstart', (ev) => {
			ev.stopPropagation();
		}, { passive: true });
	}

	// Dismiss overlays when tapping outside any tile
	document.addEventListener('touchstart', () => {
		const all = Array.from(document.querySelectorAll('[data-sticker-tile][data-active]'));
		for (const t of all) {
			t.removeAttribute('data-mode');
			t.removeAttribute('data-active');
			const labelEl = t.querySelector('[data-tile-button] [data-label]');
			if (labelEl instanceof HTMLElement) {
				const n = t.getAttribute('data-name') || '';
				labelEl.textContent = n;
			}
		}
	}, { passive: true });
</script>

---
import Layout from '../layouts/Layout.astro';
import { Copy, CopyCheck } from '@lucide/astro';
type Sticker = { name: string; src: string; alt: string };

const appStoreUrl = 'https://apps.apple.com/us/appimages/stuckers/id1173389437';

const stickers: Sticker[] = [
	{ name: 'popcorn', src: '/images/stuckers/popcorn.gif', alt: 'popcorn' },
	{ name: 'spiral', src: '/images/stuckers/spiral.gif', alt: 'spiral' },
	{ name: 'milk', src: '/images/stuckers/milk.gif', alt: 'milk' },
	{ name: 'hair', src: '/images/stuckers/hair.gif', alt: 'hair' },
	{ name: 'brows', src: '/images/stuckers/brows.gif', alt: 'brows scker' },
	{ name: 'blinky', src: '/images/stuckers/blinky.gif', alt: 'blinky' },
	{ name: 'test-tube', src: '/images/stuckers/test-tube.gif', alt: 'test tube' },
	{ name: 'wine', src: '/images/stuckers/wine.gif', alt: 'wine' },
	{ name: 'wink', src: '/images/stuckers/wink.gif', alt: 'wink' },
	{ name: 'robot', src: '/images/stuckers/robot.gif', alt: 'robot' },
];
---

<Layout
	title="crapshack (stuckers 4 u)"
	ogImage="/open-graph/stuckers.gif"
>
	<section class="mx-auto max-w-5xl text-center space-y-6">
		<!-- Top logo -->
		<div class="flex items-center justify-center">
			<img src="/images/stuckers/stuckers.png" alt="stuckers" class="block h-auto drop-shadow-lg" width="350" height="93" decoding="async" fetchpriority="high" />
		</div>

		<!-- Subtitle -->
		<p data-typed-text class="mb-10 text-white font-mono text-[clamp(18px,2.5vw,20px)] min-h-[30px] drop-shadow-lg"><noscript>stickers for phone</noscript></p>

		<!-- App Store link -->
		<div>
			<a
				href={appStoreUrl}
				target="_blank"
				rel="noopener noreferrer"
				aria-label="Download Stuckers on the App Store"
				class="inline-block transition-transform hover:scale-[1.02] focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-[var(--color-brand)]"
			>
				<img src="/images/stuckers/app-store.png" alt="Download on the App Store" width="499" height="167" decoding="async" class="h-auto max-w-[160px] sm:max-w-[180px]" />
			</a>
		</div>

		<!-- Responsive, intrinsic grid of stickers -->
		<div class="grid grid-cols-[repeat(auto-fit,minmax(10rem,1fr))] gap-4 sm:gap-6">
			{stickers.map(({ name, src, alt }) => (
				<figure class="group relative rounded-xl bg-white/70 p-2 overflow-hidden shadow-md aspect-square grid place-items-center" data-sticker-tile data-copy-url={src} data-name={name}>
					<img
						src={src}
						alt={alt}
						width="480"
						height="480"
						decoding="async"
						data-sticker-img
						class="block h-auto w-auto max-h-full max-w-full object-contain object-center origin-center transition-opacity duration-300 opacity-0 group-hover:opacity-60 group-focus-within:opacity-60 group-data-[mode=feedback]:opacity-40 drop-shadow-lg transform-gpu transition-transform group-hover:scale-[1.03]"
					/>
					<button
						type="button"
						class="absolute inset-0 z-[1] flex h-full w-full cursor-pointer rounded-xl text-white opacity-0 transition-opacity focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-[var(--color-brand)] group-hover:opacity-100 group-focus-within:opacity-100 group-data-[active=true]:opacity-100"
						data-copy-url={src}
						data-tile-button
						aria-label={`Copy link to ${name} GIF`}
					>
						<span class="absolute left-2 top-2 inline-flex items-center rounded bg-black/60 group-data-[mode=feedback]:bg-black/70 px-2 py-0.5 text-xs font-mono text-white shadow-sm select-none whitespace-nowrap leading-none transform-gpu">
							<span class="inline-flex items-center justify-center relative w-4 h-4 shrink-0 align-middle leading-none will-change-[opacity] transform-gpu">
								<Copy width={14} height={14} stroke-width={2.25} stroke="#fff" aria-hidden="true" class="absolute inset-0 opacity-100 transition-opacity group-data-[mode=feedback]:opacity-0" />
								<CopyCheck width={14} height={14} stroke-width={2.25} stroke="#fff" aria-hidden="true" class="absolute inset-0 opacity-0 transition-opacity group-data-[mode=feedback]:opacity-100" />
							</span>
							<span data-label aria-live="polite" class="leading-none ml-1.5">{name}</span>
						</span>
					</button>
				</figure>
			))}
		</div>

		<script>
			import { typedText } from '../lib/typed-text.ts';
			import { copyTextToClipboard, toAbsoluteUrl } from '../lib/clipboard.ts';
			const el = document.querySelector<HTMLElement>('[data-typed-text]');
			if (el) {
				typedText(el, 'stickers for phone');
			}

			// Fade in sticker images as they load with staggered timing
			const stickerImages = Array.from(document.querySelectorAll('[data-sticker-img]'));
			for (let i = 0; i < stickerImages.length; i++) {
				const img = stickerImages[i];
				if (!(img instanceof HTMLImageElement)) continue;
				
				const staggerDelay = i * 40; // 40ms delay between each image
				
				const fadeIn = () => {
					setTimeout(() => {
						img.classList.remove('opacity-0');
						img.classList.add('opacity-100');
					}, staggerDelay);
				};
				
				if (img.complete) {
					// Image already loaded (cached)
					fadeIn();
				} else {
					// Fade in when image loads
					img.addEventListener('load', fadeIn, { once: true });
				}
			}

			const tiles = Array.from(document.querySelectorAll('[data-sticker-tile]'));
			for (const tile of tiles) {
				const button = tile.querySelector('[data-tile-button]');
				if (!(button instanceof HTMLButtonElement)) continue;
				const label = button.querySelector('[data-label]');
				if (!(label instanceof HTMLElement)) continue;
				const stickerName = tile.getAttribute('data-name') || '';
				let feedbackTimer: number | null = null;
				const defaultLabel = stickerName;
				const feedbackLabel = 'Copied!';

				const setMode = (mode: 'feedback' | 'default') => {
					if (mode === 'feedback') {
						tile.setAttribute('data-active', 'true');
						tile.setAttribute('data-mode', 'feedback');
						label.textContent = feedbackLabel;
					} else {
						tile.removeAttribute('data-mode');
						tile.removeAttribute('data-active');
						label.textContent = defaultLabel;
					}
				};

				button.addEventListener('click', async (ev) => {
					ev.preventDefault();
					const url = toAbsoluteUrl(button.getAttribute('data-copy-url') || '');
					await copyTextToClipboard(url);
					setMode('feedback');
					if (feedbackTimer) window.clearTimeout(feedbackTimer);
					feedbackTimer = window.setTimeout(() => setMode('default'), 1200);
				});

				// Touch: keep overlay visible on first tap via feedback path
				tile.addEventListener('touchstart', (ev) => {
					ev.stopPropagation();
				}, { passive: true });
			}

			// Dismiss overlays when tapping outside any tile
			document.addEventListener('touchstart', () => {
				const all = Array.from(document.querySelectorAll('[data-sticker-tile][data-active]'));
				for (const t of all) {
					t.removeAttribute('data-mode');
					t.removeAttribute('data-active');
					const labelEl = t.querySelector('[data-tile-button] [data-label]');
					if (labelEl instanceof HTMLElement) {
						const n = t.getAttribute('data-name') || '';
						labelEl.textContent = n;
					}
				}
			}, { passive: true });
		</script>
	</section>
</Layout>
